<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ti·ªám Hoa TMT</title>
    <link rel="icon" href="images/admin.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #db2777; 
            --secondary-color: #fce7f3;
            --bg-color: #f8fafc;
            --text-color: #334155;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Quicksand', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background-color: var(--white); border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 24px; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .menu-item { padding: 12px 15px; border-radius: 10px; color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 12px; font-weight: 600; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background-color: var(--secondary-color); color: var(--primary-color); }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }

        /* Tab Content Logic */
        .tab-section { display: none; animation: fadeIn 0.3s; }
        .tab-section.active { display: block; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 20px; border-radius: 16px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 20px; }
        .card-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 24px; }
        
        .bg-pink { background-color: #fce7f3; color: #db2777; }
        .bg-blue { background-color: #dbeafe; color: #2563eb; }
        .bg-green { background-color: #dcfce7; color: #16a34a; }

        /* Table */
        .table-wrapper { background: var(--white); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; }
        .table-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .search-box input { padding: 10px 15px; border: 1px solid #e2e8f0; border-radius: 8px; width: 300px; outline: none; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; color: #64748b; border-bottom: 2px solid #f1f5f9; background: #f8fafc; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
        
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .badge-new { background: #dbeafe; color: #1e40af; }
        .badge-paid { background: #dcfce7; color: #166534; }
        .badge-cancel { background: #fee2e2; color: #991b1b; }

        /* Rank Badges - M·ªõi th√™m */
        .rank-badge { padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; display: inline-flex; align-items: center; gap: 5px; }
        .rank-bronze { background: #fff7ed; color: #9a3412; border: 1px solid #fdba74; }
        .rank-silver { background: #f8fafc; color: #475569; border: 1px solid #cbd5e1; }
        .rank-gold { background: #fefce8; color: #854d0e; border: 1px solid #fde047; }
        .rank-diamond { background: #eff6ff; color: #1e40af; border: 1px solid #60a5fa; box-shadow: 0 0 5px #93c5fd; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-danger { background: #ef4444; color: white; padding: 6px 12px; font-size: 12px; }
        .btn:hover { opacity: 0.9; }

        /* Modal (Popup th√™m s·∫£n ph·∫©m) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; outline: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-seedling"></i> Ti·ªám Hoa TMT</div>
        
        <div class="menu-item active" onclick="switchTab('dashboard', this)">
            <i class="fa-solid fa-chart-pie"></i> T·ªïng Quan
        </div>
        <div class="menu-item" onclick="switchTab('products', this)">
            <i class="fa-solid fa-seedling"></i> S·∫£n Ph·∫©m
        </div>
        <div class="menu-item" onclick="switchTab('customers', this)">
            <i class="fa-solid fa-users"></i> Kh√°ch H√†ng VIP
        </div>
        
        <div style="margin-top: auto;">
            <a href="/" class="menu-item"><i class="fa-solid fa-arrow-right-from-bracket"></i> V·ªÅ Trang Ch·ªß</a>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="tab-section active">
            <div class="stats-grid">
                <div class="card">
                    <div class="card-icon bg-pink"><i class="fa-solid fa-bag-shopping"></i></div>
                    <div><h3 id="totalOrders">0</h3><p>T·ªïng ƒê∆°n H√†ng</p></div>
                </div>
                <div class="card">
                    <div class="card-icon bg-green"><i class="fa-solid fa-money-bill-wave"></i></div>
                    <div><h3 id="totalRevenue">0 ƒë</h3><p>Doanh Thu</p></div>
                </div>
                <div class="card">
                    <div class="card-icon bg-blue"><i class="fa-solid fa-clock"></i></div>
                    <div><h3 id="lastUpdated">--:--</h3><p>C·∫≠p nh·∫≠t l√∫c</p></div>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="table-header">
                    <h3>üì¶ Danh S√°ch ƒê∆°n H√†ng</h3>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="üîç T√¨m t√™n kh√°ch, SƒêT..." onkeyup="filterOrders()">
                    </div>
                </div>
                <table>
                    <thead>
                        <tr><th>M√£</th><th>Kh√°ch H√†ng</th><th>Chi Ti·∫øt</th><th>T·ªïng Ti·ªÅn</th><th>Ng√†y ƒê·∫∑t</th><th>Tr·∫°ng Th√°i</th></tr>
                    </thead>
                    <tbody id="orderTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="products" class="tab-section">
            <div class="table-wrapper">
                <div class="table-header">
                    <h3>üåª Qu·∫£n L√Ω S·∫£n Ph·∫©m</h3>
                    <button class="btn btn-primary" onclick="openModal()">+ Th√™m Hoa M·ªõi</button>
                </div>
                <table>
                    <thead>
                        <tr><th>·∫¢nh</th><th>T√™n Hoa</th><th>Gi√° G·ªëc</th><th>Gi√° B√°n</th><th>H√†nh ƒê·ªông</th></tr>
                    </thead>
                    <tbody id="productTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="customers" class="tab-section">
            <div class="table-wrapper">
                <div class="table-header">
                    <h3>üíé B·∫£ng X·∫øp H·∫°ng Kh√°ch H√†ng Th√¢n Thi·∫øt</h3>
                    <p style="font-size:13px; color:gray">
                        <span class="rank-badge rank-bronze">ƒê·ªìng < 1Tr</span>
                        <span class="rank-badge rank-silver">B·∫°c 1-3Tr</span>
                        <span class="rank-badge rank-gold">V√†ng 3-10Tr</span>
                        <span class="rank-badge rank-diamond">B·∫°ch Kim > 10Tr</span>
                    </p>
                </div>
                <table>
                    <thead><tr><th>H·∫°ng</th><th>T√™n Kh√°ch H√†ng</th><th>SƒêT</th><th>S·ªë ƒê∆°n</th><th>T·ªïng Chi Ti√™u</th></tr></thead>
                    <tbody id="customerTableBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px; color:var(--primary-color)">Th√™m Hoa M·ªõi</h3>
            <div class="form-group"><label>T√™n Hoa</label><input type="text" id="newProdName"></div>
            <div class="form-group"><label>Gi√° (VNƒê)</label><input type="number" id="newProdPrice"></div>
            <div class="form-group"><label>Link ·∫¢nh (URL)</label><input type="text" id="newProdImg" placeholder="images/..."></div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn" style="background:#f1f5f9; margin-right:10px; color:#333" onclick="closeModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="addProduct()">L∆∞u S·∫£n Ph·∫©m</button>
            </div>
        </div>
    </div>

    <script>
        // --- D·ªÆ LI·ªÜU KH·ªûI T·∫†O ---
        let hoaTuoi = [
            { id: 1, name: 'Hoa H·ªìng ƒê·ªè', price: 550000, salePrice: 490000, image: 'images/hoahong.jpg' },
            { id: 2, name: 'Hoa Ly Tr·∫Øng', price: 480000, image: 'images/hoaly.jpg' },
            { id: 3, name: 'Hoa H∆∞·ªõng D∆∞∆°ng', price: 450000, image: 'images/hoahuongduong.jpg' },
            { id: 4, name: 'Hoa C·∫©m T√∫ C·∫ßu', price: 620000, image: 'images/camtucau.jpg' },
            { id: 5, name: 'Tulip H√† Lan', price: 750000, image: 'images/tulip.jpg' },
            { id: 6, name: 'Hoa C√∫c Tana', price: 400000, image: 'images/cuctana.jpg' },
            { id: 7, name: 'Hoa Baby Tr·∫Øng', price: 380000, salePrice: 290000, image: 'images/hoababy.jpg' },
            { id: 8, name: 'Lan H·ªì ƒêi·ªáp', price: 1200000, salePrice: 1000000, image: 'images/lanhodiep.jpg' },
            { id: 9, name: 'M·∫´u ƒê∆°n H·ªìng', price: 850000, image: 'images/maudon.jpg' },
            { id: 10, name: 'O·∫£i H∆∞∆°ng Kh√¥', price: 420000, image: 'images/oaihuong.jpg' },
            { id: 11, name: 'C·∫©m Ch∆∞·ªõng', price: 390000, salePrice: 290000, image: 'images/camchuong.jpg' },
            { id: 12, name: 'C√∫c H·ªça Mi', price: 350000, image: 'images/cuchoami.jpg' },
            { id: 13, name: 'Hoa Sen Tr·∫Øng', price: 500000, image: 'images/hoasen.jpg' },
            { id: 14, name: 'C√°t T∆∞·ªùng', price: 460000, image: 'images/cattuong.jpg' },
            { id: 15, name: 'Th·∫°ch Th·∫£o T√≠m', price: 370000, image: 'images/thachthao.jpg' },
            { id: 16, name: 'Hoa Rum', price: 580000, image: 'images/rum.jpg' },
            { id: 17, name: 'ƒê·ªìng Ti·ªÅn', price: 410000, image: 'images/dongtien.jpg' },
            { id: 18, name: 'Salem T√≠m', price: 360000, image: 'images/salem.jpg' },
            { id: 19, name: 'M√µm S√≥i', price: 430000, image: 'images/momsoi.jpg' },
            { id: 20, name: 'Th·ªßy Ti√™n Tr·∫Øng', price: 490000, image: 'images/thuytien.jpg' }
        ];

        let allOrders = [];

        // 1. Chuy·ªÉn Tab
        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(element) {
                document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }
        }

        // 2. Format ti·ªÅn
        const formatMoney = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

        // 3. T·∫£i ƒë∆°n h√†ng & T√≠nh to√°n
        async function loadOrders() {
            try {
                let res = await fetch('/api/orders/all');
                if (res.ok) {
                    allOrders = await res.json();
                    renderOrders(allOrders);
                    processCustomerData(allOrders); 
                
                    // T·ªïng quan
                    let total = allOrders.reduce((sum, ord) => sum + (ord.totalAmount || 0), 0);
                    document.getElementById('totalRevenue').innerText = formatMoney(total);
                    document.getElementById('totalOrders').innerText = allOrders.length;
                    document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString('vi-VN');
                }
            } catch (err) { console.error(err); }
        }

        // H√†m ƒë·ªãnh d·∫°ng ng√†y gi·ªù theo m√∫i gi·ªù Vi·ªát Nam
        function formatDateVN(dateString) {
            if (!dateString) return '';
            const dateStr = dateString.endsWith('Z') ? dateString : dateString + 'Z';
            const date = new Date(dateStr);
            
            return date.toLocaleString('vi-VN', {
                hour: '2-digit', 
                minute: '2-digit',
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric'
            }); 
        }

        // 4. V·∫Ω b·∫£ng ƒë∆°n h√†ng
        function renderOrders(orders) {
            let html = '';
            orders.forEach(order => {
                let badge = order.status === 'MOI_TAO' ? 'badge-new' : (order.status === 'CANCELLED' ? 'badge-cancel' : 'badge-paid');
                
                let timeVN = formatDateVN(order.orderDate);

                html += `
                    <tr>
                        <td style="font-weight:bold; color:#64748b">#${order.id}</td>
                        <td>
                            <div style="font-weight:bold; color:#334155">${order.customerName}</div>
                            <div style="font-size:12px; color:#94a3b8">${order.phone}</div>
                        </td>
                        <td>
                            <div style="font-size:13px">${order.address}</div>
                            <div style="font-size:12px; color:#64748b; font-style:italic">"${order.note || ''}"</div>
                        </td>
                        <td style="color:var(--primary-color); font-weight:700">${formatMoney(order.totalAmount)}</td>
                        
                        <td style="font-size:13px; font-weight:600">${timeVN}</td>
                        
                        <td><span class="badge ${badge}">${order.status}</span></td>
                    </tr>
                `;
            });
            document.getElementById('orderTableBody').innerHTML = html || '<tr><td colspan="6" align="center" style="padding:20px; color:gray">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
        }

        // 4. LOGIC X·∫æP H·∫†NG KH√ÅCH H√ÄNG
        function processCustomerData(orders) {
            let customers = {};

            // Gom nh√≥m theo s·ªë ƒëi·ªán tho·∫°i
            orders.forEach(order => {
                let phone = order.phone;
                if (!phone) return;

                if (!customers[phone]) {
                    customers[phone] = { 
                        name: order.customerName, 
                        phone: phone, 
                        count: 0, 
                        totalSpent: 0 
                    };
                }
                customers[phone].count += 1;
                customers[phone].totalSpent += order.totalAmount || 0;
            });

            // Chuy·ªÉn object th√†nh m·∫£ng & s·∫Øp x·∫øp theo t·ªïng ti·ªÅn gi·∫£m d·∫ßn
            let sortedCustomers = Object.values(customers).sort((a, b) => b.totalSpent - a.totalSpent);

            // Render ra b·∫£ng
            let html = '';
            sortedCustomers.forEach(c => {
                let rankBadge = '';
                let total = c.totalSpent;

                // Thu·∫≠t to√°n x·∫øp h·∫°ng
                if (total >= 10000000) {
                    rankBadge = '<span class="rank-badge rank-diamond"><i class="fa-solid fa-gem"></i> B·∫°ch Kim</span>';
                } else if (total >= 3000000) {
                    rankBadge = '<span class="rank-badge rank-gold"><i class="fa-solid fa-crown"></i> V√†ng</span>';
                } else if (total >= 1000000) {
                    rankBadge = '<span class="rank-badge rank-silver"><i class="fa-solid fa-medal"></i> B·∫°c</span>';
                } else {
                    rankBadge = '<span class="rank-badge rank-bronze"><i class="fa-solid fa-shield"></i> ƒê·ªìng</span>';
                }

                html += `
                    <tr>
                        <td>${rankBadge}</td>
                        <td><b>${c.name}</b></td>
                        <td>${c.phone}</td>
                        <td>${c.count} ƒë∆°n</td>
                        <td style="color:#db2777; font-weight:bold">${formatMoney(c.totalSpent)}</td>
                    </tr>
                `;
            });
            document.getElementById('customerTableBody').innerHTML = html || '<tr><td colspan="5" align="center">Ch∆∞a c√≥ d·ªØ li·ªáu kh√°ch h√†ng</td></tr>';
        }

        // 5. QU·∫¢N L√ù S·∫¢N PH·∫®M
        function renderProducts() {
            let html = '';
            hoaTuoi.forEach((p, index) => {
                // ∆Øu ti√™n hi·ªán gi√° khuy·∫øn m√£i
                let displayPrice = p.salePrice ? 
                    `<span style="text-decoration:line-through; color:gray; font-size:12px">${formatMoney(p.price)}</span> <br> ${formatMoney(p.salePrice)}` : 
                    formatMoney(p.price);

                html += `
                    <tr>
                        <td><img src="${p.image}" width="50" style="border-radius:5px"></td>
                        <td><b>${p.name}</b></td>
                        <td>${formatMoney(p.price)}</td>
                        <td style="color:#db2777; font-weight:bold">${displayPrice}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteProduct(${index})"><i class="fa-solid fa-trash"></i> X√≥a</button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('productTableBody').innerHTML = html;
        }

        function addProduct() {
            let name = document.getElementById('newProdName').value;
            let price = document.getElementById('newProdPrice').value;
            let img = document.getElementById('newProdImg').value || 'images/hoahong.jpg';

            if (name && price) {
                // Th√™m v√†o ƒë·∫ßu m·∫£ng
                hoaTuoi.unshift({
                    id: Date.now(),
                    name: name,
                    price: parseInt(price),
                    image: img
                });
                renderProducts();
                closeModal();
                alert("ƒê√£ th√™m hoa m·ªõi th√†nh c√¥ng!");
            } else {
                alert("Vui l√≤ng nh·∫≠p t√™n v√† gi√°!");
            }
        }

        function deleteProduct(index) {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) {
                hoaTuoi.splice(index, 1); // X√≥a kh·ªèi m·∫£ng
                renderProducts(); // V·∫Ω l·∫°i b·∫£ng
            }
        }

        // Modal Logic
        function openModal() { document.getElementById('productModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('productModal').style.display = 'none'; }

        function filterOrders() {
            let text = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allOrders.filter(o => (o.customerName && o.customerName.toLowerCase().includes(text)) || (o.phone && o.phone.includes(text)));
            renderOrders(filtered);
        }

        // --- KH·ªûI ƒê·ªòNG ---
        loadOrders();
        renderProducts(); 
        setInterval(loadOrders, 10000); // C·∫≠p nh·∫≠t ƒë∆°n m·ªói 10s
    </script>
</body>
</html>